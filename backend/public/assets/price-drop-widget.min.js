!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).PriceDropWidget=e()}(this,function(){"use strict";class t{constructor(t={}){var e,n;this.container=null,this.state="idle",this.shadowRoot=null,this.config={apiEndpoint:t.apiEndpoint||"/subscribe-price-drop",product:t.product||this.extractProductData(),containerId:t.containerId||"price-drop-widget-root",cssUrl:t.cssUrl||"/assets/widget.css",htmlTemplate:t.htmlTemplate,theme:{accentColor:(null==(e=t.theme)?void 0:e.accentColor)||"#FF9900",backgroundColor:(null==(n=t.theme)?void 0:n.backgroundColor)||"#ffffff"}}}extractProductData(){return{name:document.title||"Unknown Product",price:"N/A",url:window.location.href}}async init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.render()):await this.render()}async render(){if(this.container=document.getElementById(this.config.containerId),!this.container)return void console.error(`Widget container #${this.config.containerId} not found`);this.shadowRoot=this.container.attachShadow({mode:"open"}),await this.loadStyles();const t=await this.createWidgetElement();this.shadowRoot.appendChild(t),this.attachEventListeners()}async loadStyles(){const{accentColor:t,backgroundColor:e}=this.config.theme,n=document.createElement("style");n.textContent=`\n            :host {\n                --pdw-accent: ${t};\n                --pdw-bg: ${e};\n            }\n        `,this.shadowRoot.appendChild(n);try{const t=await fetch(this.config.cssUrl);if(!t.ok)throw new Error("Failed to load CSS");{const e=await t.text(),n=document.createElement("style");n.textContent=e,this.shadowRoot.appendChild(n)}}catch(o){console.warn("Failed to load external CSS, using inline fallback");const t=document.createElement("style");t.textContent=this.getFallbackStyles(),this.shadowRoot.appendChild(t)}}getFallbackStyles(){return"\n      :host {\n        --pdw-text: #1a1a1a;\n        --pdw-text-light: #666;\n        --pdw-border: #e0e0e0;\n        --pdw-error: #d32f2f;\n        --pdw-success: #388e3c;\n        \n        display: block;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;\n        font-size: 14px;\n        line-height: 1.5;\n        color: var(--pdw-text);\n        box-sizing: border-box;\n      }\n      \n      *, *::before, *::after {\n        box-sizing: border-box;\n      }\n      \n      .pdw-container {\n        background: var(--pdw-bg);\n        border: 1px solid var(--pdw-border);\n        border-radius: 8px;\n        padding: 16px;\n        max-width: 400px;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        animation: pdw-fadeIn 0.3s ease-out;\n      }\n      \n      @keyframes pdw-fadeIn {\n        from { opacity: 0; transform: translateY(-10px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n      \n      .pdw-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }\n      .pdw-icon { font-size: 20px; line-height: 1; }\n      .pdw-title { font-size: 16px; font-weight: 600; margin: 0; color: var(--pdw-text); }\n      .pdw-description { font-size: 13px; color: var(--pdw-text-light); margin: 0 0 16px 0; }\n      .pdw-product-info { background: #f8f8f8; border-radius: 4px; padding: 8px; margin-bottom: 16px; font-size: 12px; }\n      .pdw-product-name { font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n      .pdw-product-price { color: var(--pdw-accent); font-weight: 700; font-size: 14px; }\n      .pdw-form { display: flex; flex-direction: column; gap: 12px; }\n      .pdw-input { width: 100%; padding: 10px 12px; border: 2px solid var(--pdw-border); border-radius: 6px; font-size: 14px; outline: none; transition: border-color 0.2s ease; font-family: inherit; }\n      .pdw-input:focus { border-color: var(--pdw-accent); }\n      .pdw-input::placeholder { color: #999; }\n      .pdw-button { width: 100%; padding: 10px 16px; background: var(--pdw-accent); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-family: inherit; position: relative; overflow: hidden; }\n      .pdw-button:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }\n      .pdw-button:active:not(:disabled) { transform: translateY(0); }\n      .pdw-button:disabled { opacity: 0.6; cursor: not-allowed; }\n      .pdw-button.submitting { animation: pdw-pulse 1.5s ease-in-out infinite; }\n      @keyframes pdw-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }\n      .pdw-message { padding: 10px 12px; border-radius: 6px; font-size: 13px; margin-top: 12px; display: none; animation: pdw-slideDown 0.3s ease-out; }\n      @keyframes pdw-slideDown { from { opacity: 0; transform: translateY(-10px); max-height: 0; } to { opacity: 1; transform: translateY(0); max-height: 100px; } }\n      .pdw-message.show { display: block; }\n      .pdw-message.success { background: #e8f5e9; color: var(--pdw-success); border: 1px solid #c8e6c9; }\n      .pdw-message.error { background: #ffebee; color: var(--pdw-error); border: 1px solid #ffcdd2; }\n      .pdw-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: pdw-spin 0.6s linear infinite; margin-right: 8px; vertical-align: middle; }\n      @keyframes pdw-spin { to { transform: rotate(360deg); } }\n      @media (max-width: 480px) {\n        .pdw-container { padding: 12px; }\n        .pdw-title { font-size: 14px; }\n        .pdw-input, .pdw-button { font-size: 13px; }\n      }\n    "}async loadTemplate(){return this.config.htmlTemplate?this.config.htmlTemplate:this.getInlineTemplate()}getInlineTemplate(){return'\n      <div class="pdw-container">\n        <div class="pdw-header">\n          <span class="pdw-icon">üîî</span>\n          <h3 class="pdw-title">Price Drop Alert</h3>\n        </div>\n        <p class="pdw-description">Get notified when the price drops!</p>\n        <div class="pdw-product-info">\n          <div class="pdw-product-name" data-pdw="product-name"></div>\n          <div class="pdw-product-price" data-pdw="product-price"></div>\n        </div>\n        <form class="pdw-form" id="pdw-form">\n          <input \n            type="email" \n            class="pdw-input" \n            id="pdw-email" \n            placeholder="your.email@example.com" \n            required \n            autocomplete="email"\n            aria-label="Email address"\n          />\n          <button type="submit" class="pdw-button" id="pdw-submit">\n            Notify Me\n          </button>\n        </form>\n        <div class="pdw-message" id="pdw-message" role="alert"></div>\n      </div>\n    '}async createWidgetElement(){const t=document.createElement("div"),e=await this.loadTemplate();t.innerHTML=e;const n=t.querySelector('[data-pdw="product-name"]'),o=t.querySelector('[data-pdw="product-price"]');return n&&(n.textContent=this.escapeHtml(this.config.product.name),n.setAttribute("title",this.escapeHtml(this.config.product.name))),o&&(o.textContent=this.escapeHtml(this.config.product.price)),t.firstElementChild}attachEventListeners(){const t=this.shadowRoot.querySelector("#pdw-form");t&&t.addEventListener("submit",t=>this.handleSubmit(t));const e=this.shadowRoot.querySelector("#pdw-email");e&&e.addEventListener("keydown",t=>{"Escape"===t.key&&e.blur()})}async handleSubmit(t){if(t.preventDefault(),"submitting"===this.state)return;const e=this.shadowRoot.querySelector("#pdw-email"),n=this.shadowRoot.querySelector("#pdw-submit"),o=e.value.trim();if(!o||!this.validateEmail(o))return void this.showMessage("Please enter a valid email address","error");this.setState("submitting"),n.innerHTML='<span class="pdw-spinner"></span>Subscribing...',n.classList.add("submitting");const i={email:o,product:this.config.product};try{const t=await this.submitSubscription(i);t.ok?(this.setState("success"),this.showMessage("‚úÖ Success! We'll notify you when the price drops.","success"),e.value="",this.markAsSubscribed()):this.handleError(t)}catch(r){this.setState("error"),this.showMessage("‚ùå Network error. Please check your connection.","error")}finally{n.innerHTML="Notify Me",n.classList.remove("submitting"),setTimeout(()=>{"submitting"!==this.state&&this.setState("idle")},3e3)}}async submitSubscription(t){const e=new AbortController,n=setTimeout(()=>e.abort(),3e4);try{const o=await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:e.signal});clearTimeout(n);const i=await o.json();return{ok:o.ok,status:o.status,data:i}}catch(o){throw clearTimeout(n),o}}handleError(t){var e;this.setState("error");const n={invalid_email:"‚ùå Please enter a valid email address",already_subscribed:"‚ÑπÔ∏è You're already subscribed to this product",server_error:"‚ö†Ô∏è Server error. Please try again later."}[null==(e=t.data)?void 0:e.error]||"‚ùå Something went wrong. Please try again.";this.showMessage(n,"error")}showMessage(t,e){const n=this.shadowRoot.querySelector("#pdw-message");n&&(n.textContent=t,n.className=`pdw-message ${e} show`)}setState(t){this.state=t}validateEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}markAsSubscribed(){try{const t=`pdw_subscribed_${this.config.product.url}`;localStorage.setItem(t,"true")}catch(t){console.warn("Could not save subscription state")}}isSubscribed(){try{const t=`pdw_subscribed_${this.config.product.url}`;return"true"===localStorage.getItem(t)}catch(t){return!1}}}return"undefined"!=typeof window&&(window.PriceDropWidget=t),t});
